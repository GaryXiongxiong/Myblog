<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Kafka 消费者篇 · 蒋亦雄的博客</title><meta name="description" content="Kafka 消费者篇 - Yixiong Jiang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://jiangyixiong.top/atom.xml" title="蒋亦雄的博客"><meta name="generator" content="Hexo 5.0.0"><link rel="alternate" href="/atom.xml" title="蒋亦雄的博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/categories/blog" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/categories/podcast" target="_self" class="nav-list-link">PODCAST</a></li><li class="nav-list-item"><a href="https://github.com/GaryXiongxiong" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/resume/" target="_self" class="nav-list-link">RESUME</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Kafka 消费者篇</h1><div class="post-info">2020年9月3日</div><div class="post-content"><h2 id="消费者与消费者组"><a href="#消费者与消费者组" class="headerlink" title="消费者与消费者组"></a>消费者与消费者组</h2><p>消费者组是若干个消费者组成的集合，一个消费者组包含以下特性：</p>
<ul>
<li>一个消费者组可以有一个或多个消费者实例</li>
<li>消费者组名（GroupId）通常由一个一个字符串表示，有唯一性。</li>
<li>当一个消费者组订阅了主题，那么该主题中的每个分区职能分配给否一个消费者组中的某一个消费者程序</li>
</ul>
<p>一个分区对应一个消费者，一个消费者可以负责多个分区。消费者数量尽量不要超过话题的分区数，否则多出的消费者将处于空闲状态。</p>
<p><img src="/images/kafka-consumer.png" alt="image-20200904103005821"></p>
<h2 id="使用脚本控制消费者"><a href="#使用脚本控制消费者" class="headerlink" title="使用脚本控制消费者"></a>使用脚本控制消费者</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --broker-list broker_name:port --topic topic_name</span><br></pre></td></tr></table></figure>

<h2 id="使用消费者API"><a href="#使用消费者API" class="headerlink" title="使用消费者API"></a>使用消费者API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ConsumerRecords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaConsumerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建并写入客户端配置</span></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">//Kafka 集群地址合集</span></span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        <span class="comment">//Kafka 消费者组id</span></span><br><span class="line">        props.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;CountryCounter&quot;</span>);</span><br><span class="line">        <span class="comment">//反序列化器</span></span><br><span class="line">        props.put(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serializaiton.StrignDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serializaiton.StrignDeserializer&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//根据配置创建consumer</span></span><br><span class="line">           KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(props);</span><br><span class="line">        <span class="comment">//订阅topic</span></span><br><span class="line">           consumer.subscribe(Collections.singletonList(<span class="string">&quot;test&quot;</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 100 是超时时间（ms），在该时间内 poll 会等待服务器返回数据</span></span><br><span class="line">                ConsumerReccords&lt;String, String&gt; records = consumer.poll(<span class="number">100</span>); </span><br><span class="line">                </span><br><span class="line">                <span class="comment">// poll 返回一个记录列表。</span></span><br><span class="line">                <span class="comment">// 每条记录都包含了记录所属主题的信息、记录所在分区的信息、记录在分区里的偏移量，以及记录的键值对。</span></span><br><span class="line">                <span class="keyword">for</span> (ConsumerReccord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;topic=%s, partition=%s, offset=%d, key=%s, value=%s&quot;</span>,</span><br><span class="line">                        record.topic(), record.partition(), record.offset(), </span><br><span class="line">                        record.key(), record.value());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭消费者,网络连接和 socket 也会随之关闭，并立即触发一次再均衡</span></span><br><span class="line">            consumer.close();</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>KafkaConsumer是非多线程并发安全的：如果多个线程公用一个KafkaConsumer实例，则抛出异常错误信息。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/09/07/Spring-Cloud-OpenFeign-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" class="prev">上一篇</a><a href="/2020/09/02/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85%E7%AF%87/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://jiangyixiong.top">Yixiong Jiang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>